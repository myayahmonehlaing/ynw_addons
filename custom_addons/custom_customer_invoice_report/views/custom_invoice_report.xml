<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="custom_report_invoice_document" inherit_id="account.report_invoice_document">

        <!-- Remove original document title -->
        <xpath expr="//t[@t-set='layout_document_title']" position="replace"/>

        <!-- Custom Invoice Header -->
        <xpath expr="//div[@class='clearfix invoice_main']" position="before">
            <div style="margin: 15px 0;">
                <h2 style="text-align: left;">
                    <t t-if="o.state == 'draft' and o.move_type == 'out_invoice'">Draft Invoice</t>
                    <t t-if="o.state == 'draft' and o.move_type == 'out_refund'">Draft Credit Note</t>
                    <t t-if="o.state == 'draft' and o.move_type == 'in_invoice'">Draft Vendor Bill</t>
                    <t t-if="o.state == 'draft' and o.move_type == 'in_refund'">Draft Vendor Credit Note</t>

                    <t t-if="not o.name or o.name == '/'">INV/2023/0001</t>
                    <t t-else="">
                        <span t-field="o.name"/>
                    </t>
                </h2>
            </div>
        </xpath>

        <!-- Replace invoice line loop -->
        <xpath expr="//tbody[@class='invoice_tbody']/t[@t-foreach]" position="replace">
            <t t-set="display_discount" t-value="any(l.discount for l in o.invoice_line_ids)"/>
            <t t-set="lines"
               t-value="[l for l in o.invoice_line_ids if l.display_type != 'product' or (l.price_unit or 0) &gt;= 0]"/>
            <t t-foreach="lines" t-as="line">
                <tr t-att-class="'fw-bold o_line_section' if line.display_type == 'line_section' else 'fst-italic o_line_note' if line.display_type == 'line_note' else ''">
                    <t t-if="line.display_type == 'product'">
                        <td>
                            <span t-field="line.name"/>
                        </td>
                        <td class="text-end">
                            <t t-esc="('%.2f' % line.quantity).rstrip('0').rstrip('.')"/>
                            <t t-esc="line.product_uom_id.name"/>
<!--                            <span t-field="line.quantity"/>-->
<!--                            <span t-field="line.product_uom_id.name"/>-->
                        </td>
                        <td class="text-end">
                            <span>
                                <t t-if="o.currency_id.name == 'MMK'">
                                    <t t-esc="('%.2f' % line.price_unit).rstrip('0').rstrip('.')"/>
                                    <t t-esc="o.currency_id.symbol"/>
                                </t>
                                <t t-else="">
                                    <t t-esc="o.currency_id.symbol"/>
                                    <t t-esc="('%.2f' % line.price_unit).rstrip('0').rstrip('.')"/>
                                </t>
                            </span>
                        </td>
                        <td class="text-end" t-if="display_discount">
                            <t t-if="line.discount"><span t-esc="line.discount"/>%
                            </t>
                        </td>
                        <t t-set="taxes"
                           t-value="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_ids])"/>
                        <td class="text-end">
                            <span t-out="taxes"/>
                        </td>
                        <td class="text-end">
                            <span>
                                <t t-if="o.currency_id.name == 'MMK'">
                                    <t t-esc="('%.2f' % line.price_subtotal).rstrip('0').rstrip('.')"/>
                                    <t t-esc="o.currency_id.symbol"/>
                                </t>
                                <t t-else="">
                                    <t t-esc="o.currency_id.symbol"/>
                                    <t t-esc="('%.2f' % line.price_subtotal).rstrip('0').rstrip('.')"/>
                                </t>
                            </span>
                        </td>
                    </t>
                    <t t-elif="line.display_type == 'line_section'">
                        <td colspan="99">
                            <span t-field="line.name" t-options="{'widget': 'text'}"/>
                        </td>
                    </t>
                    <t t-elif="line.display_type == 'line_note'">
                        <td colspan="99">
                            <span t-field="line.name" t-options="{'widget': 'text'}"/>
                        </td>
                    </t>
                </tr>
            </t>
        </xpath>

        <!-- Custom Totals -->
        <xpath expr="//t[@t-call='account.document_tax_totals']" position="replace">
            <t t-set="subtotal"
               t-value="sum([l.price_subtotal for l in o.invoice_line_ids if l.price_subtotal &gt;= 0])"/>
            <t t-set="discount_total"
               t-value="abs(sum([l.price_subtotal for l in o.invoice_line_ids if l.price_subtotal &lt; 0]))"/>
            <t t-set="tax_total"
               t-value="sum([l.price_total - l.price_subtotal for l in o.invoice_line_ids])"/>
            <t t-set="final_total" t-value="subtotal - discount_total + tax_total"/>

            <table class="o_total_table table table-borderless">
                <tr>
                    <td>
                        <strong>Sub Total</strong>
                    </td>
                    <td class="text-end">
                        <t t-if="o.currency_id.name == 'MMK'">
                            <t t-esc="('%.2f' % subtotal).rstrip('0').rstrip('.')"/>
                            <t t-esc="o.currency_id.symbol"/>
                        </t>
                        <t t-else="">
                            <t t-esc="o.currency_id.symbol"/>
                            <t t-esc="('%.2f' % subtotal).rstrip('0').rstrip('.')"/>
                        </t>
                    </td>
                </tr>
                <tr>
                    <td>
                        <strong>Discount</strong>
                    </td>
                    <td class="text-end">
                        <t t-if="o.currency_id.name == 'MMK'">
                            <t t-esc="('%.2f' % discount_total).rstrip('0').rstrip('.')"/>
                            <t t-esc="o.currency_id.symbol"/>
                        </t>
                        <t t-else="">
                            <t t-esc="o.currency_id.symbol"/>
                            <t t-esc="('%.2f' % discount_total).rstrip('0').rstrip('.')"/>
                        </t>
                    </td>
                </tr>
                <tr>
                    <td>
                        <strong>Tax</strong>
                    </td>
                    <td class="text-end">
                        <t t-if="o.currency_id.name == 'MMK'">
                            <t t-esc="('%.2f' % tax_total).rstrip('0').rstrip('.')"/>
                            <t t-esc="o.currency_id.symbol"/>
                        </t>
                        <t t-else="">
                            <t t-esc="o.currency_id.symbol"/>
                            <t t-esc="('%.2f' % tax_total).rstrip('0').rstrip('.')"/>
                        </t>
                    </td>
                </tr>
                <tr class="o_total">
                    <td>
                        <strong>Total</strong>
                    </td>
                    <td class="text-end">
                        <strong>
                            <t t-if="o.currency_id.name == 'MMK'">
                                <t t-esc="('%.2f' % final_total).rstrip('0').rstrip('.')"/>
                                <t t-esc="o.currency_id.symbol"/>
                            </t>
                            <t t-else="">
                                <t t-esc="o.currency_id.symbol"/>
                                <t t-esc="('%.2f' % final_total).rstrip('0').rstrip('.')"/>
                            </t>
                        </strong>
                    </td>
                </tr>
            </table>

        </xpath>

    </template>
</odoo>
